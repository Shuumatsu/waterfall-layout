import { Subject } from 'rxjs/Subject';
import 'rxjs/add/operator/debounceTime';
import 'rxjs/add/operator/distinctUntilChanged';
// import 'rxjs/add/operator/map';
// import 'rxjs/add/operator/switchMap';
// import 'rxjs/add/operator/toPromise';
function flat(...args) {
    let extended = {};
    args.forEach(v => {
        for (let key in v) {
            if (typeof v[key] === 'object' && !Array.isArray(v[key])) {
                Object.assign(extended, flat(v[key]));
                continue;
            }
            extended[key] = v[key];
        }
    });
    return extended;
}
function debounce(fn, delay, immediate) {
    let timeout;
    return function () {
        let context = this, args = arguments;
        let later = () => {
            timeout = null;
            if (!immediate) {
                fn.apply(context, args);
            }
        };
        let callNow = immediate && !timeout;
        clearTimeout(timeout);
        timeout = setTimeout(later, delay);
        if (callNow) {
            fn.apply(context, args);
        }
    };
}
class Option {
}
const defaultConfig = {
    breakPoints: [480, 720, 960, 1080],
    gap: '1em'
};
// cache breakPoints:number[] gap:string itemWidth:string style:HTMLElement
export function Waterfall(container) {
    this.container = container;
    if (!this.container.style.position || this.container.style.position === 'static') {
        this.container.style.position = 'relative';
    }
    let option = JSON.parse(container.getAttribute('data-option'));
    option.breakPoints = option.breakPoints || option.breakPoints.sort();
    if (typeof option.gap === 'number' && option.gap !== 0) {
        option.gap += 'px';
    }
    this.cache = flat(defaultConfig, option);
    this.styleElements();
    this.elements = Array.from(this.container.querySelectorAll('.waterfall-item'));
    this.numChangeSubject = new Subject();
    this.maxHeightSubject = new Subject();
    this.newElementsSubject = new Subject();
    this.resizeSubject = new Subject();
    this.numChangeSubject.distinctUntilChanged().subscribe(num => {
        this.setElementsWidth(num);
        this._positionElementsFactory(num);
        this.positionElements(this.elements);
    });
    this.maxHeightSubject.debounceTime(300).distinctUntilChanged().subscribe(maxHeight => {
        this.container.style.height = maxHeight + 'px';
    });
    this.newElementsSubject.subscribe(newElements => {
        this.appendNewElements(newElements);
        this.elements = this.elements.concat(newElements);
        this.positionElements(newElements);
    });
    this.resizeSubject.distinctUntilChanged().subscribe(clientWidth => {
        this.calcColNum(clientWidth);
    });
    function resizeHandler() {
        this.resizeSubject.next(document.body.clientWidth);
    }
    window.addEventListener('resize', debounce(resizeHandler.bind(this), 300));
    this.resizeSubject.next(document.body.clientWidth);
}
// Waterfall.prototype.hideElements = function (elements: HTMLElement[]) {
//     elements.forEach(el => {
//         el.style.transition = '';
//         el.style.opacity = '0';
//     });
// }
// Waterfall.prototype.showElements = function (elements: HTMLElement[]) {
//     elements.forEach(el => {
//         el.style.transition = 'opacity 0.225s 0.125s';
//         el.style.opacity = '1';
//     });
// }
Waterfall.prototype._positionElementsFactory = function (num) {
    let cols = new Array(num);
    for (let i = 0; i < cols.length; i++) {
        cols[i] = [];
    }
    let tops = new Array(num);
    for (let i = 0; i < tops.length; i++) {
        tops[i] = 0;
    }
    Waterfall.prototype.positionElements = (elements) => {
        elements.forEach(v => {
            let i = tops.indexOf(Math.min.apply(null, tops));
            v.style.left = `calc((${this.cache.elementWidth} + ${this.cache.gap}) * ${i})`;
            v.style.top = tops[i] + 'px';
            v.style.opacity = '1';
            cols[i].push(v);
            tops[i] += parseFloat(window.getComputedStyle(v).getPropertyValue('height')) + parseFloat(window.getComputedStyle(v).getPropertyValue('margin-bottom'));
            this.maxHeightSubject.next(Math.max.apply(null, tops));
        });
    };
};
Waterfall.prototype.calcColNum = function (clientWidth) {
    let num = this.cache.breakPoints.length;
    this.cache.breakPoints.find((v, i) => {
        if (clientWidth < v) {
            num = i + 1;
            return true;
        }
    });
    this.numChangeSubject.next(num);
};
Waterfall.prototype.setElementsWidth = function (num) {
    this.cache.elementWidth = `calc((100% - ${num - 1} * ${this.cache.gap}) / ${num})`;
    this.cache.style.innerHTML += `
    .waterfall-item {
        width: ${this.cache.elementWidth};
    }`;
};
Waterfall.prototype.styleElements = function () {
    let style = document.createElement('style');
    style.id = 'waterfall-item-style';
    style.innerHTML = `.waterfall-item {
        position: absolute;
        transition: opacity 0.225s 0.225s;
    }`;
    this.cache.style = style;
    this.container.insertBefore(style, this.container.firstChild);
};
Waterfall.prototype.addElements = function (elements) {
    if (!Array.isArray(elements)) {
        elements = [elements];
    }
    this.newElementsSubject.next(elements);
};
Waterfall.prototype.appendNewElements = function (elements) {
    let fragment = document.createDocumentFragment();
    elements.forEach(element => {
        element.style.opacity = '0';
        element.classList.add('waterfall-item');
        fragment.appendChild(element);
    });
    this.container.appendChild(fragment);
};

//# sourceMappingURL=data:application/json;base64,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QUM1QyxLQUFLLENBQUMsRUFBRSxHQUFHLHNCQUFzQixDQUFDO0lBQ2xDLEtBQUssQ0FBQyxTQUFTLEdBQUc7OztNQUdoQixDQUFDO0lBRUgsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLEdBQUcsS0FBSyxDQUFDO0lBQ3pCLElBQUksQ0FBQyxTQUFTLENBQUMsWUFBWSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ2xFLENBQUMsQ0FBQztBQUVGLFNBQVMsQ0FBQyxTQUFTLENBQUMsV0FBVyxHQUFHLFVBQVUsUUFBcUM7SUFDN0UsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMzQixRQUFRLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBRUQsSUFBSSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMzQyxDQUFDLENBQUE7QUFFRCxTQUFTLENBQUMsU0FBUyxDQUFDLGlCQUFpQixHQUFHLFVBQVUsUUFBdUI7SUFDckUsSUFBSSxRQUFRLEdBQUcsUUFBUSxDQUFDLHNCQUFzQixFQUFFLENBQUM7SUFFakQsUUFBUSxDQUFDLE9BQU8sQ0FBQyxPQUFPO1FBQ3BCLE9BQU8sQ0FBQyxLQUFLLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQztRQUM1QixPQUFPLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO1FBQ3hDLFFBQVEsQ0FBQyxXQUFXLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDbEMsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUN6QyxDQUFDLENBQUEiLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTdWJqZWN0IH0gZnJvbSAncnhqcy9TdWJqZWN0JztcblxuLy8gaW1wb3J0ICdyeGpzL2FkZC9vcGVyYXRvci9jYXRjaCc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL2RlYm91bmNlVGltZSc7XG5pbXBvcnQgJ3J4anMvYWRkL29wZXJhdG9yL2Rpc3RpbmN0VW50aWxDaGFuZ2VkJztcbi8vIGltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvbWFwJztcbi8vIGltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3Ivc3dpdGNoTWFwJztcbi8vIGltcG9ydCAncnhqcy9hZGQvb3BlcmF0b3IvdG9Qcm9taXNlJztcblxuZnVuY3Rpb24gZmxhdCguLi5hcmdzOiBPYmplY3RbXSkge1xuICAgIGxldCBleHRlbmRlZCA9IHt9O1xuICAgIGFyZ3MuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgZm9yIChsZXQga2V5IGluIHYpIHtcbiAgICAgICAgICAgIGlmICh0eXBlb2YgdltrZXldID09PSAnb2JqZWN0JyAmJiAhQXJyYXkuaXNBcnJheSh2W2tleV0pKSB7XG4gICAgICAgICAgICAgICAgT2JqZWN0LmFzc2lnbihleHRlbmRlZCwgZmxhdCh2W2tleV0pKTtcbiAgICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cblxuICAgICAgICAgICAgZXh0ZW5kZWRba2V5XSA9IHZba2V5XTtcbiAgICAgICAgfVxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGV4dGVuZGVkO1xufVxuXG5mdW5jdGlvbiBkZWJvdW5jZShmbjogRnVuY3Rpb24sIGRlbGF5OiBudW1iZXIsIGltbWVkaWF0ZT86IGJvb2xlYW4pIHtcbiAgICBsZXQgdGltZW91dDtcblxuICAgIHJldHVybiBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGxldCBjb250ZXh0ID0gdGhpcywgYXJncyA9IGFyZ3VtZW50cztcbiAgICAgICAgbGV0IGxhdGVyID0gKCkgPT4ge1xuICAgICAgICAgICAgdGltZW91dCA9IG51bGw7XG4gICAgICAgICAgICBpZiAoIWltbWVkaWF0ZSkge1xuICAgICAgICAgICAgICAgIGZuLmFwcGx5KGNvbnRleHQsIGFyZ3MpO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGxldCBjYWxsTm93ID0gaW1tZWRpYXRlICYmICF0aW1lb3V0O1xuICAgICAgICBjbGVhclRpbWVvdXQodGltZW91dCk7XG4gICAgICAgIHRpbWVvdXQgPSBzZXRUaW1lb3V0KGxhdGVyLCBkZWxheSk7XG4gICAgICAgIGlmIChjYWxsTm93KSB7XG4gICAgICAgICAgICBmbi5hcHBseShjb250ZXh0LCBhcmdzKTtcbiAgICAgICAgfVxuICAgIH1cbn1cblxuY2xhc3MgT3B0aW9uIHtcbiAgICBicmVha1BvaW50czogbnVtYmVyW107XG4gICAgZ2FwOiBudW1iZXIgfCBzdHJpbmc7XG59XG5cbmNvbnN0IGRlZmF1bHRDb25maWcgPSB7XG4gICAgYnJlYWtQb2ludHM6IFs0ODAsIDcyMCwgOTYwLCAxMDgwXSxcbiAgICBnYXA6ICcxZW0nXG59XG5cblxuLy8gY2FjaGUgYnJlYWtQb2ludHM6bnVtYmVyW10gZ2FwOnN0cmluZyBpdGVtV2lkdGg6c3RyaW5nIHN0eWxlOkhUTUxFbGVtZW50XG5leHBvcnQgZnVuY3Rpb24gV2F0ZXJmYWxsKGNvbnRhaW5lcjogSFRNTEVsZW1lbnQpIHtcbiAgICB0aGlzLmNvbnRhaW5lciA9IGNvbnRhaW5lcjtcbiAgICBpZiAoIXRoaXMuY29udGFpbmVyLnN0eWxlLnBvc2l0aW9uIHx8IHRoaXMuY29udGFpbmVyLnN0eWxlLnBvc2l0aW9uID09PSAnc3RhdGljJykge1xuICAgICAgICB0aGlzLmNvbnRhaW5lci5zdHlsZS5wb3NpdGlvbiA9ICdyZWxhdGl2ZSc7XG4gICAgfVxuXG4gICAgbGV0IG9wdGlvbiA9IEpTT04ucGFyc2UoY29udGFpbmVyLmdldEF0dHJpYnV0ZSgnZGF0YS1vcHRpb24nKSk7XG4gICAgb3B0aW9uLmJyZWFrUG9pbnRzID0gb3B0aW9uLmJyZWFrUG9pbnRzIHx8IG9wdGlvbi5icmVha1BvaW50cy5zb3J0KCk7XG4gICAgaWYgKHR5cGVvZiBvcHRpb24uZ2FwID09PSAnbnVtYmVyJyAmJiBvcHRpb24uZ2FwICE9PSAwKSB7XG4gICAgICAgIG9wdGlvbi5nYXAgKz0gJ3B4JztcbiAgICB9XG4gICAgdGhpcy5jYWNoZSA9IGZsYXQoZGVmYXVsdENvbmZpZywgb3B0aW9uKTtcblxuICAgIHRoaXMuc3R5bGVFbGVtZW50cygpO1xuXG4gICAgdGhpcy5lbGVtZW50cyA9IDxIVE1MRWxlbWVudFtdPkFycmF5LmZyb20odGhpcy5jb250YWluZXIucXVlcnlTZWxlY3RvckFsbCgnLndhdGVyZmFsbC1pdGVtJykpO1xuXG4gICAgdGhpcy5udW1DaGFuZ2VTdWJqZWN0ID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xuICAgIHRoaXMubWF4SGVpZ2h0U3ViamVjdCA9IG5ldyBTdWJqZWN0PG51bWJlcj4oKTtcbiAgICB0aGlzLm5ld0VsZW1lbnRzU3ViamVjdCA9IG5ldyBTdWJqZWN0PEhUTUxFbGVtZW50W10+KCk7XG4gICAgdGhpcy5yZXNpemVTdWJqZWN0ID0gbmV3IFN1YmplY3Q8bnVtYmVyPigpO1xuXG4gICAgdGhpcy5udW1DaGFuZ2VTdWJqZWN0LmRpc3RpbmN0VW50aWxDaGFuZ2VkKCkuc3Vic2NyaWJlKFxuICAgICAgICBudW0gPT4ge1xuICAgICAgICAgICAgdGhpcy5zZXRFbGVtZW50c1dpZHRoKG51bSk7XG4gICAgICAgICAgICB0aGlzLl9wb3NpdGlvbkVsZW1lbnRzRmFjdG9yeShudW0pO1xuICAgICAgICAgICAgdGhpcy5wb3NpdGlvbkVsZW1lbnRzKHRoaXMuZWxlbWVudHMpO1xuICAgICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMubWF4SGVpZ2h0U3ViamVjdC5kZWJvdW5jZVRpbWUoMzAwKS5kaXN0aW5jdFVudGlsQ2hhbmdlZCgpLnN1YnNjcmliZShcbiAgICAgICAgbWF4SGVpZ2h0ID0+IHtcbiAgICAgICAgICAgIHRoaXMuY29udGFpbmVyLnN0eWxlLmhlaWdodCA9IG1heEhlaWdodCArICdweCc7XG4gICAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy5uZXdFbGVtZW50c1N1YmplY3Quc3Vic2NyaWJlKFxuICAgICAgICBuZXdFbGVtZW50cyA9PiB7XG4gICAgICAgICAgICB0aGlzLmFwcGVuZE5ld0VsZW1lbnRzKG5ld0VsZW1lbnRzKTtcbiAgICAgICAgICAgIHRoaXMuZWxlbWVudHMgPSB0aGlzLmVsZW1lbnRzLmNvbmNhdChuZXdFbGVtZW50cyk7XG4gICAgICAgICAgICB0aGlzLnBvc2l0aW9uRWxlbWVudHMobmV3RWxlbWVudHMpO1xuICAgICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMucmVzaXplU3ViamVjdC5kaXN0aW5jdFVudGlsQ2hhbmdlZCgpLnN1YnNjcmliZShcbiAgICAgICAgY2xpZW50V2lkdGggPT4ge1xuICAgICAgICAgICAgdGhpcy5jYWxjQ29sTnVtKGNsaWVudFdpZHRoKTtcbiAgICAgICAgfVxuICAgICk7XG5cbiAgICBmdW5jdGlvbiByZXNpemVIYW5kbGVyKCkge1xuICAgICAgICB0aGlzLnJlc2l6ZVN1YmplY3QubmV4dChkb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoKTtcbiAgICB9XG4gICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIGRlYm91bmNlKHJlc2l6ZUhhbmRsZXIuYmluZCh0aGlzKSwgMzAwKSk7XG4gICAgdGhpcy5yZXNpemVTdWJqZWN0Lm5leHQoPG51bWJlcj5kb2N1bWVudC5ib2R5LmNsaWVudFdpZHRoKTtcbn1cblxuLy8gV2F0ZXJmYWxsLnByb3RvdHlwZS5oaWRlRWxlbWVudHMgPSBmdW5jdGlvbiAoZWxlbWVudHM6IEhUTUxFbGVtZW50W10pIHtcbi8vICAgICBlbGVtZW50cy5mb3JFYWNoKGVsID0+IHtcbi8vICAgICAgICAgZWwuc3R5bGUudHJhbnNpdGlvbiA9ICcnO1xuLy8gICAgICAgICBlbC5zdHlsZS5vcGFjaXR5ID0gJzAnO1xuLy8gICAgIH0pO1xuLy8gfVxuXG4vLyBXYXRlcmZhbGwucHJvdG90eXBlLnNob3dFbGVtZW50cyA9IGZ1bmN0aW9uIChlbGVtZW50czogSFRNTEVsZW1lbnRbXSkge1xuLy8gICAgIGVsZW1lbnRzLmZvckVhY2goZWwgPT4ge1xuLy8gICAgICAgICBlbC5zdHlsZS50cmFuc2l0aW9uID0gJ29wYWNpdHkgMC4yMjVzIDAuMTI1cyc7XG4vLyAgICAgICAgIGVsLnN0eWxlLm9wYWNpdHkgPSAnMSc7XG4vLyAgICAgfSk7XG4vLyB9XG5cbldhdGVyZmFsbC5wcm90b3R5cGUuX3Bvc2l0aW9uRWxlbWVudHNGYWN0b3J5ID0gZnVuY3Rpb24gKG51bTogbnVtYmVyKSB7XG4gICAgbGV0IGNvbHM6IEhUTUxFbGVtZW50W11bXSA9IG5ldyBBcnJheShudW0pO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgY29scy5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb2xzW2ldID0gW107XG4gICAgfVxuICAgIGxldCB0b3BzOiBudW1iZXJbXSA9IG5ldyBBcnJheShudW0pO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdG9wcy5sZW5ndGg7IGkrKykge1xuICAgICAgICB0b3BzW2ldID0gMDtcbiAgICB9XG5cbiAgICBXYXRlcmZhbGwucHJvdG90eXBlLnBvc2l0aW9uRWxlbWVudHMgPSAoZWxlbWVudHM6IEhUTUxFbGVtZW50W10pID0+IHtcbiAgICAgICAgZWxlbWVudHMuZm9yRWFjaCh2ID0+IHtcbiAgICAgICAgICAgIGxldCBpOiBudW1iZXIgPSB0b3BzLmluZGV4T2YoTWF0aC5taW4uYXBwbHkobnVsbCwgdG9wcykpO1xuXG4gICAgICAgICAgICB2LnN0eWxlLmxlZnQgPSBgY2FsYygoJHt0aGlzLmNhY2hlLmVsZW1lbnRXaWR0aH0gKyAke3RoaXMuY2FjaGUuZ2FwfSkgKiAke2l9KWA7XG4gICAgICAgICAgICB2LnN0eWxlLnRvcCA9IHRvcHNbaV0gKyAncHgnO1xuICAgICAgICAgICAgdi5zdHlsZS5vcGFjaXR5ID0gJzEnO1xuICAgICAgICAgICAgY29sc1tpXS5wdXNoKHYpO1xuICAgICAgICAgICAgdG9wc1tpXSArPSBwYXJzZUZsb2F0KHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKHYpLmdldFByb3BlcnR5VmFsdWUoJ2hlaWdodCcpKSArIHBhcnNlRmxvYXQod2luZG93LmdldENvbXB1dGVkU3R5bGUodikuZ2V0UHJvcGVydHlWYWx1ZSgnbWFyZ2luLWJvdHRvbScpKTtcblxuICAgICAgICAgICAgdGhpcy5tYXhIZWlnaHRTdWJqZWN0Lm5leHQoPG51bWJlcj5NYXRoLm1heC5hcHBseShudWxsLCB0b3BzKSk7XG4gICAgICAgIH0pO1xuICAgIH1cbn07XG5cbldhdGVyZmFsbC5wcm90b3R5cGUuY2FsY0NvbE51bSA9IGZ1bmN0aW9uIChjbGllbnRXaWR0aDogbnVtYmVyKSB7XG4gICAgbGV0IG51bSA9IHRoaXMuY2FjaGUuYnJlYWtQb2ludHMubGVuZ3RoO1xuXG4gICAgdGhpcy5jYWNoZS5icmVha1BvaW50cy5maW5kKCh2LCBpKSA9PiB7XG4gICAgICAgIGlmIChjbGllbnRXaWR0aCA8IHYpIHtcbiAgICAgICAgICAgIG51bSA9IGkgKyAxO1xuICAgICAgICAgICAgcmV0dXJuIHRydWU7XG4gICAgICAgIH1cbiAgICB9KTtcblxuICAgIHRoaXMubnVtQ2hhbmdlU3ViamVjdC5uZXh0KG51bSk7XG59O1xuXG5XYXRlcmZhbGwucHJvdG90eXBlLnNldEVsZW1lbnRzV2lkdGggPSBmdW5jdGlvbiAobnVtOiBudW1iZXIpIHtcbiAgICB0aGlzLmNhY2hlLmVsZW1lbnRXaWR0aCA9IGBjYWxjKCgxMDAlIC0gJHtudW0gLSAxfSAqICR7dGhpcy5jYWNoZS5nYXB9KSAvICR7bnVtfSlgO1xuXG4gICAgdGhpcy5jYWNoZS5zdHlsZS5pbm5lckhUTUwgKz0gYFxuICAgIC53YXRlcmZhbGwtaXRlbSB7XG4gICAgICAgIHdpZHRoOiAke3RoaXMuY2FjaGUuZWxlbWVudFdpZHRofTtcbiAgICB9YFxufTtcblxuV2F0ZXJmYWxsLnByb3RvdHlwZS5zdHlsZUVsZW1lbnRzID0gZnVuY3Rpb24gKCkge1xuICAgIGxldCBzdHlsZSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3N0eWxlJyk7XG4gICAgc3R5bGUuaWQgPSAnd2F0ZXJmYWxsLWl0ZW0tc3R5bGUnO1xuICAgIHN0eWxlLmlubmVySFRNTCA9IGAud2F0ZXJmYWxsLWl0ZW0ge1xuICAgICAgICBwb3NpdGlvbjogYWJzb2x1dGU7XG4gICAgICAgIHRyYW5zaXRpb246IG9wYWNpdHkgMC4yMjVzIDAuMjI1cztcbiAgICB9YDtcblxuICAgIHRoaXMuY2FjaGUuc3R5bGUgPSBzdHlsZTtcbiAgICB0aGlzLmNvbnRhaW5lci5pbnNlcnRCZWZvcmUoc3R5bGUsIHRoaXMuY29udGFpbmVyLmZpcnN0Q2hpbGQpO1xufTtcblxuV2F0ZXJmYWxsLnByb3RvdHlwZS5hZGRFbGVtZW50cyA9IGZ1bmN0aW9uIChlbGVtZW50czogSFRNTEVsZW1lbnQgfCBIVE1MRWxlbWVudFtdKSB7XG4gICAgaWYgKCFBcnJheS5pc0FycmF5KGVsZW1lbnRzKSkge1xuICAgICAgICBlbGVtZW50cyA9IFtlbGVtZW50c107XG4gICAgfVxuXG4gICAgdGhpcy5uZXdFbGVtZW50c1N1YmplY3QubmV4dChlbGVtZW50cyk7XG59XG5cbldhdGVyZmFsbC5wcm90b3R5cGUuYXBwZW5kTmV3RWxlbWVudHMgPSBmdW5jdGlvbiAoZWxlbWVudHM6IEhUTUxFbGVtZW50W10pIHtcbiAgICBsZXQgZnJhZ21lbnQgPSBkb2N1bWVudC5jcmVhdGVEb2N1bWVudEZyYWdtZW50KCk7XG5cbiAgICBlbGVtZW50cy5mb3JFYWNoKGVsZW1lbnQgPT4ge1xuICAgICAgICBlbGVtZW50LnN0eWxlLm9wYWNpdHkgPSAnMCc7XG4gICAgICAgIGVsZW1lbnQuY2xhc3NMaXN0LmFkZCgnd2F0ZXJmYWxsLWl0ZW0nKTtcbiAgICAgICAgZnJhZ21lbnQuYXBwZW5kQ2hpbGQoZWxlbWVudCk7XG4gICAgfSk7XG5cbiAgICB0aGlzLmNvbnRhaW5lci5hcHBlbmRDaGlsZChmcmFnbWVudCk7XG59XG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=
